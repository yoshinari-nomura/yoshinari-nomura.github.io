<!-- MHonArc v2.6.16 -->
<!--X-Subject: [mhc:02036] mhc2palm/palm2mhc =?ISO&#45;2022&#45;JP?B?GyRCJE4lKyVGJTQlaiVRJUMlQRsoQg==?= -->
<!--X-From-R13: YAWS Vvqrgnxn (=?vfb&#45;2022&#45;wc?P?UlDQAVS5BwTDFwCoYSW=?=) <uvqrNxbvr.bet> -->
<!--X-Date: Tue, 22 Feb 2005 19:09:00 +0900 (JST) -->
<!--X-Message-Id: 20050222.190900.189704049.hide@koie.org -->
<!--X-Content-Type: multipart/mixed -->
<!--X-Head-End-->
<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
        "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
<title>[mhc:02036] mhc2palm/palm2mhc &#x306E;&#x30AB;&#x30C6;&#x30B4;&#x30EA;&#x30D1;&#x30C3;&#x30C1;</title>
</head>
<body>
<!--X-Body-Begin-->
<!--X-User-Header-->
<!--X-User-Header-End-->
<!--X-TopPNI-->
<hr>
[<a href="msg02034.html">Date Prev</a>][<a href="msg02036.html">Date Next</a>][<a href="msg02034.html">Thread Prev</a>][<a href="msg02036.html">Thread Next</a>][<a href="maillist.html#02035">Date Index</a>][<a href="threads.html#02035">Thread Index</a>]
<!--X-TopPNI-End-->
<!--X-MsgBody-->
<!--X-Subject-Header-Begin-->
<h1>[mhc:02036] mhc2palm/palm2mhc &#x306E;&#x30AB;&#x30C6;&#x30B4;&#x30EA;&#x30D1;&#x30C3;&#x30C1;</h1>
<hr>
<!--X-Subject-Header-End-->
<!--X-Head-of-Message-->
<ul>
<li><em>To</em>: <a href="mailto:mhc@DOMAIN.HIDDEN">mhc@xxxxxxxxxxxxx</a></li>
<li><em>Subject</em>: [mhc:02036] mhc2palm/palm2mhc &#x306E;&#x30AB;&#x30C6;&#x30B4;&#x30EA;&#x30D1;&#x30C3;&#x30C1;</li>
<li><em>From</em>: KOIE Hidetaka (&#x9BC9;&#x6C5F;&#x82F1;&#x9686;) &lt;<a href="mailto:hide@DOMAIN.HIDDEN">hide@xxxxxxxx</a>&gt;</li>
<li><em>Date</em>: Tue, 22 Feb 2005 19:09:00 +0900 (JST)</li>
<li><em>Reply-to</em>: <a href="mailto:mhc@DOMAIN.HIDDEN">mhc@xxxxxxxxxxxxx</a></li>
</ul>
<!--X-Head-of-Message-End-->
<!--X-Head-Body-Sep-Begin-->
<hr>
<!--X-Head-Body-Sep-End-->
<!--X-Body-of-Message-->
<pre>&#x3061;&#x304B;&#x3054;&#x308D;Palm&#x3067;&#x30C6;&#x30EC;&#x30D3;&#x756A;&#x7D44;&#x4E88;&#x5B9A;&#x3092;&#x3069;&#x3093;&#x3069;&#x3093;&#x8FFD;&#x52A0;&#x3057;&#x3066;&#x3044;&#x308B;&#x3093;&#x3067;&#x3059;&#x304C;
&#x4ED5;&#x4E8B;&#x306E;&#x4E88;&#x5B9A;&#x304C;&#x307F;&#x3065;&#x3089;&#x304F;&#x306A;&#x3063;&#x3066;&#x304D;&#x305F;&#x306E;&#x3067;&#x30AB;&#x30C6;&#x30B4;&#x30EA;&#x3067;&#x5206;&#x985E;&#x3057;&#x3088;&#x3046;&#x3068;&#x3057;&#x3066;&#x307E;&#x3059;&#x3002;
palm2mhc/mhc2palm&#x304C;&#x30AB;&#x30C6;&#x30B4;&#x30EA;&#x3092;&#x6271;&#x3048;&#x306A;&#x3044;&#x306E;&#x3067;
&#x307F;&#x3088;&#x3046;&#x307F;&#x307E;&#x306D;&#x3067;&#x6271;&#x3048;&#x308B;&#x3088;&#x3046;&#x306B;&#x3057;&#x3066;&#x307F;&#x307E;&#x3057;&#x305F;&#x3002;
&#x3061;&#x306A;&#x307F;&#x306B;&#x30AB;&#x30C6;&#x30B4;&#x30EA;&#x3092;&#x6271;&#x3048;&#x308B;Palm&#x30A2;&#x30D7;&#x30EA;&#x306B;&#x306F;KsDatebook&#x306A;&#x3069;&#x304C;&#x3042;&#x308A;&#x307E;&#x3059;&#x3002;

&#x3068;&#x308A;&#x3042;&#x3048;&#x305A;&#x30D1;&#x30C3;&#x30C1;&#x3092;&#x6295;&#x3052;&#x307E;&#x3059;&#x3002;
#&#x3053;&#x306E;&#x30D1;&#x30C3;&#x30C1;&#x306B;&#x306F;&#x4EE5;&#x524D;&#x306B;&#x6295;&#x3052;&#x305F;&#x306E;&#x3082;&#x542B;&#x307E;&#x308C;&#x3066;&#x3044;&#x307E;&#x3059;

&#x5236;&#x7D04;&#x4E8B;&#x9805;:
palm&#x3067;&#x306F;&#x30AB;&#x30C6;&#x30B4;&#x30EA;&#x306F;1&#x3064;&#x3060;&#x3051;&#x8A2D;&#x5B9A;&#x3067;&#x304D;&#x307E;&#x3059;&#x304C;
mhc&#x3067;&#x306F;&#x8907;&#x6570;&#x6307;&#x5B9A;&#x3067;&#x304D;&#x308B;&#x306E;&#x3067;
mhc2palm&#x3067;&#x306F;X-SC-Category:&#x306E;&#x306A;&#x304B;&#x3067;&#x6700;&#x521D;&#x306B;palm&#x306B;&#x30AB;&#x30C6;&#x30B4;&#x30EA;&#x3068;&#x3057;&#x3066;
&#x767B;&#x9332;&#x3055;&#x308C;&#x3066;&#x3044;&#x308B;&#x3082;&#x306E;&#x3092;&#x8A2D;&#x5B9A;&#x3059;&#x308B;&#x3088;&#x3046;&#x306B;&#x3057;&#x307E;&#x3057;&#x305F;&#x3002;

&#x4F8B;&#x3048;&#x3070;&#x3001;palm&#x3067;&#x30AB;&#x30C6;&#x30B4;&#x30EA;&#x3068;&#x3057;&#x3066;Foo&#x3068;Bar&#x304C;&#x767B;&#x9332;&#x3055;&#x308C;&#x3066;&#x3044;&#x308B;&#x3068;&#x304D;&#x306B;
mhc&#x306E;&#x4E88;&#x5B9A;&#x304C;
  X-SC-Category: Hoge Bar Foo
&#x3068;&#x306A;&#x3063;&#x3066;&#x3044;&#x308B;&#x3068;&#x3001;Bar &#x304C;&#x9078;&#x629E;&#x3055;&#x308C;&#x307E;&#x3059;&#x3002;

--
&#x9BC9;&#x6C5F;&#x82F1;&#x9686; &lt;hide@xxxxxxxx&gt;
</pre><pre>Index: mhc2palm.in
===================================================================
RCS file: /cvsroot/mhc/mhc2palm.in,v
retrieving revision 1.6
diff -u -r1.6 mhc2palm.in
--- mhc2palm.in	13 Sep 2001 05:15:17 -0000	1.6
+++ mhc2palm.in	22 Feb 2005 09:12:41 -0000
@@ -21,7 +21,7 @@
 
 def usage
   print '
-usage: mhc2palm [-a | -i] [-n] [-d dev] [-r dir] [YYYYMMDD-yyyymmdd]
+usage: mhc2palm [-a | -i] [-n] [-d dev] [-r dir] [-A mon] [-B mon] [YYYYMMDD-yyyymmdd]
 
   mhc2palm -- Add/Copy mhc articles to a palm.
 
@@ -35,6 +35,8 @@
              default value is /dev/pilot
     -r dir : Set repository directory of the mhc.
              ~/Mail/schedule
+    -A mon : XXX
+    -B mon : XXX
 
     YYYYMMDD-yyyymmdd : set a start and end date of scanning mhc.
                         if omitted, scan from 3 months ago to
@@ -69,6 +71,7 @@
 $flag_verbose = false
 $flag_noharm, $flag_append, $flag_install = false, false, false
 $flag_device, $flag_from, $flag_to = '/dev/pilot', nil, nil
+$flag_before, $flag_after = -3, 3
 $flag_dir = File .expand_path(&quot;~/Mail/schedule&quot;)
 
 while ARGV .length &gt; 0
@@ -87,6 +90,12 @@
   when '-r'
     ARGV .shift
     $flag_dir = ARGV[0]
+  when '-A'
+    ARGV .shift
+    $flag_after = ARGV[0] . to_i
+  when '-B'
+    ARGV .shift
+    $flag_before = - (ARGV[0] . to_i)
   when /^(\d{8})-(\d{8})$/
     $flag_from, $flag_to = MhcDate .new($1), MhcDate .new($2)
   else
@@ -95,8 +104,9 @@
   ARGV .shift
 end
 
-$flag_from = MhcDate .new .m_succ!(-3) if !$flag_from
-$flag_to   = MhcDate .new .m_succ!(+3) if !$flag_to
+usage() if ($flag_before &gt;= $flag_after)
+$flag_from = MhcDate .new .m_succ!($flag_before) if !$flag_from
+$flag_to   = MhcDate .new .m_succ!($flag_after) if !$flag_to
 
 usage() if !($flag_append || $flag_install) || ($flag_append &amp;&amp; $flag_install)
 
@@ -105,7 +115,7 @@
 ##
 
 if !$flag_noharm
-  if !File .exist?($flag_device)
+  if $flag_device != &quot;net:&quot; &amp;&amp; !File .exist?($flag_device)
     STDERR .print &quot;Can not open #{$flag_device}.\n&quot;
     exit 1
   end
@@ -138,6 +148,9 @@
 
   print &quot;adding &quot;, MhcKconv::todisp(sch .subject), &quot;\n&quot; if $flag_verbose
 
+  # XXX koie
+  sch .set_pilot_db(pdb)
+
   if p_rec_array = sch .to_palm
     if $flag_verbose
       print &quot;    converted into #{p_rec_array .length} palm article#{p_rec_array .length == 1 ? '' : 's'}.&quot;



Index: palm2mhc.in
===================================================================
RCS file: /cvsroot/mhc/palm2mhc.in,v
retrieving revision 1.4
diff -u -r1.4 palm2mhc.in
--- palm2mhc.in	9 Feb 2001 09:37:06 -0000	1.4
+++ palm2mhc.in	22 Feb 2005 09:12:41 -0000
@@ -75,7 +75,7 @@
   ARGV .shift
 end
 
-if !File .exist?($flag_device)
+if $flag_device != &quot;net:&quot; &amp;&amp; !File .exist?($flag_device)
   STDERR .print &quot;Can not open #{$flag_device}.\n&quot;
   exit 1
 end



Index: ruby-ext/mhc_pilib.c
===================================================================
RCS file: /cvsroot/mhc/ruby-ext/mhc_pilib.c,v
retrieving revision 1.5
diff -u -r1.5 mhc_pilib.c
--- ruby-ext/mhc_pilib.c	15 Nov 2004 00:40:01 -0000	1.5
+++ ruby-ext/mhc_pilib.c	22 Feb 2005 09:12:41 -0000
@@ -491,6 +491,45 @@
   return ary;
 }
 
+/* XXX koie */
+static VALUE rpack_AppointmentAppInfo(VALUE o, VALUE ary1)
+{
+  struct AppointmentAppInfo ai;
+  unsigned char buf[0xffff];
+  int len;
+  VALUE ary = ary_new();
+  ary_copy(ary, ary1);
+
+  ar_get2(ary, &quot;b&quot;, ai.category.renamed, 16);
+  ar_get2(ary, &quot;c&quot;, ai.category.ID, 16);
+  ar_get1(ary, &quot;c&quot;, ai.category.lastUniqueID);
+
+  ar_get1(ary, &quot;i&quot;, ai.startOfWeek);
+
+  len = pack_AppointmentAppInfo(&amp;ai, buf, sizeof(buf));
+  return str_new(buf, len);
+}
+
+
+/* XXX koie */
+static VALUE runpack_AppointmentAppInfo(VALUE o, VALUE raw_str)
+{
+  struct AppointmentAppInfo ai;
+  VALUE ary = ary_new();
+
+  Check_Type(raw_str, T_STRING);
+  unpack_AppointmentAppInfo(&amp;ai, RSTRING(raw_str)-&gt;ptr, RSTRING(raw_str)-&gt;len);
+
+  ar_set2(ary, &quot;b&quot;, ai.category.renamed, 16);
+  ar_set2(ary, &quot;s16&quot;, ai.category.name, 16);
+  ar_set2(ary, &quot;c&quot;, ai.category.ID, 16);
+  ar_set1(ary, &quot;c&quot;, ai.category.lastUniqueID);
+
+  ar_set1(ary, &quot;i&quot;, ai.startOfWeek);
+
+  return ary;
+}  
+
 /****************************************************************/
 /********* For Address Records **********************************/
 /****************************************************************/
@@ -541,6 +580,7 @@
   ar_get1(ary, &quot;c&quot;, ai.category.lastUniqueID);
 
   ar_get2(ary, &quot;s16&quot;, ai.labels, 22);
+  /* XXX koie ar_get2(ary, &quot;b&quot;,   ai.labelRenamed, 22) */
   ar_get2(ary, &quot;s16&quot;, ai.phoneLabels, 8);
   ar_get1(ary, &quot;i&quot;, ai.country);
   ar_get1(ary, &quot;b&quot;, ai.sortByCompany);
@@ -684,6 +724,9 @@
   /* for datebook */
   mfunc(mPiLib, &quot;pack_Appointment&quot;,      rpack_Appointment,      1);
   mfunc(mPiLib, &quot;unpack_Appointment&quot;,    runpack_Appointment,    1);
+  /* XXX koie */
+  mfunc(mPiLib, &quot;pack_AppointmentAppInfo&quot;,   rpack_AppointmentAppInfo,   1);
+  mfunc(mPiLib, &quot;unpack_AppointmentAppInfo&quot;, runpack_AppointmentAppInfo, 1);
 
   /* for address */
   mfunc(mPiLib, &quot;pack_Address&quot;,          rpack_Address,          1);



Index: ruby-ext/lib/mhc-palm.rb
===================================================================
RCS file: /cvsroot/mhc/ruby-ext/lib/mhc-palm.rb,v
retrieving revision 1.11
diff -u -r1.11 mhc-palm.rb
--- ruby-ext/lib/mhc-palm.rb	22 Jun 2004 10:09:15 -0000	1.11
+++ ruby-ext/lib/mhc-palm.rb	22 Feb 2005 09:12:42 -0000
@@ -93,6 +93,8 @@
   def each_record
     i = 0
     while (rec = record_by_index(i)) != nil
+      # XXX koie
+      rec .set_pilot_db(self)
       yield rec
       i += 1
     end
@@ -132,6 +134,10 @@
   def get_app_info()
     return PiLib .dlp_ReadAppBlock(@sd, @db)
   end
+
+  def find_category(catname)
+    return -1
+  end
 end
 
 ################################################################
@@ -143,10 +149,17 @@
 class PilotRecord
   def initialize(id = 0, attr = 0, category = 0, data = '')
     @id, @attr, @category, @data = id, attr, category, data
+    # XXX koie
+    @pilot_db = nil
     unpack
     check
   end
 
+  # XXX koie
+  def set_pilot_db(pilot_db)
+    @pilot_db = pilot_db
+  end
+
   attr :id
   def set_id(id)
     raise &quot;Integer required.&quot; if !(id .is_a?(Integer))
@@ -303,8 +316,29 @@
 class PilotApptDB &lt; PilotDB
   def initialize(pi, dbname)
     super
+
+    # XXX koie
+    app_info = self .get_app_info
+
+    @catRenamed, @catName, @catID, @catLastUniqueID, 
+      # [22]       [22]          [8]
+      @startOfWeek = *PiLib .unpack_AppointmentAppInfo(app_info)
+
     @recClass = PilotApptRecord
   end
+  def get_catName(idx)
+    return @catName[idx]
+  end
+
+  # XXX koie
+  def find_category(catname)
+    for idx in 0 .. 15
+      if @catName[idx].capitalize == catname.capitalize
+        return idx
+      end
+    end
+    return -1
+  end
 end
 
 
@@ -586,7 +620,16 @@
     xsc[&quot;Subject&quot;]    = Kconv::tojis(Kconv::toeuc(@description) .sub(/\[[^\]]*\]\s*$/, ''))
     xsc[&quot;Location&quot;]   = Kconv::tojis($1) if Kconv::toeuc(@description) =~ /\[([^\]]+)\]\s*$/
     xsc[&quot;Note&quot;]       = Kconv::tojis(@note)
-    xsc[&quot;Category&quot;]   = @category  if category?
+    # XXX koie
+    #xsc[&quot;Category&quot;]   = @category  if category?
+    if category?
+      catname = @pilot_db .get_catName(@category)
+      #STDERR .print &quot;XXX: &lt;#{@category}&gt; &lt;#{catname}&gt;\n&quot;
+      if catname == &quot;&quot;
+	  catname = @category .to_s
+      end
+      xsc[&quot;Category&quot;]   = catname
+    end
     xsc[&quot;Alarm&quot;]      = alarm
     xsc[&quot;Day&quot;]        = @exception .collect{|t| '!' + t .to_xscday} .join(' ')
     xsc[&quot;Day&quot;]       += ' ' + @beg .to_xscday if !repeat?
@@ -598,6 +641,16 @@
       end
     end
 
+    if attribute_secret?
+      if xsc[&quot;Category&quot;]
+	if xsc[&quot;Category&quot;] !~ /private/i
+          xsc[&quot;Category&quot;] += ' Private'
+	end
+      else
+	xsc[&quot;Category&quot;] = 'Private'
+      end
+    end
+
     if repeat?
       if @repeatFrequency &gt; 1
 	STDERR .print &quot;#{@beg} : #{Kconv::tojis(@description)} &quot;
@@ -664,13 +717,10 @@
 
     part1, part2 = string .split(&quot;\n\n&quot;, 2)
 
-    if !(part1 =~ /^[ \t]+/ or part1 =~ /^[A-Za-z0-9_-]+:/)
-      part1_is_header = false
-    end
-
     part1 .split(&quot;\n&quot;) .each{|line|
-      if !(string =~ /^[ \t]+/ or string =~ /^[A-Za-z0-9_-]+:/)
-	part1_is_header = false
+      if !(line =~ /^([ \t]|[A-Za-z][A-Za-z0-9_-]*:)/)
+        part1_is_header = false
+	break
       end
     }
 



Index: ruby-ext/lib/mhc-schedule.rb
===================================================================
RCS file: /cvsroot/mhc/ruby-ext/lib/mhc-schedule.rb,v
retrieving revision 1.21
diff -u -r1.21 mhc-schedule.rb
--- ruby-ext/lib/mhc-schedule.rb	25 Oct 2004 02:28:57 -0000	1.21
+++ ruby-ext/lib/mhc-schedule.rb	22 Feb 2005 09:12:42 -0000
@@ -195,6 +195,13 @@
     end
     set_rec_id(create_record_id) if ! rec_id
     set_modified(false, 'initialize')
+    # XXX koie
+    @pilot_db = nil
+  end
+
+  # XXX koie
+  def set_pilot_db (pilot_db)
+    @pilot_db = pilot_db
   end
 
   ################################################################
@@ -840,6 +847,22 @@
       # STDERR .print &quot;#{occur_min .to_js} : #{subject} unsupported. ignored..\n&quot;
       return nil
     else
+      if category_as_string =~ /private/i
+        ret .each{|r|
+          r .set_attribute_secret
+	}
+      end
+      # XXX koie
+      category .each{|cat|
+	### ret is an array of instance of PilotApptRecord
+	idx = @pilot_db .find_category(cat)
+        if idx &gt;= 0
+	  ret .each{|r|
+	    r .set_category(idx)
+	  }
+	  break
+	end
+      }
       return ret
     end
   end
</pre>
<!--X-Body-of-Message-End-->
<!--X-MsgBody-End-->
<!--X-Follow-Ups-->
<hr>
<!--X-Follow-Ups-End-->
<!--X-References-->
<!--X-References-End-->
<!--X-BotPNI-->
<ul>
<li>Prev by Date:
<strong><a href="msg02034.html">[mhc:02035] mhc-cvs and conflict</a></strong>
</li>
<li>Next by Date:
<strong><a href="msg02036.html">[mhc:02037] &#x7D42;&#x4E86;&#x65E5;&#x306E;&#x306A;&#x3044;&#x4E88;&#x5B9A;&#x306E; palm2mhc</a></strong>
</li>
<li>Previous by thread:
<strong><a href="msg02034.html">[mhc:02035] mhc-cvs and conflict</a></strong>
</li>
<li>Next by thread:
<strong><a href="msg02036.html">[mhc:02037] &#x7D42;&#x4E86;&#x65E5;&#x306E;&#x306A;&#x3044;&#x4E88;&#x5B9A;&#x306E; palm2mhc</a></strong>
</li>
<li>Index(es):
<ul>
<li><a href="maillist.html#02035"><strong>Date</strong></a></li>
<li><a href="threads.html#02035"><strong>Thread</strong></a></li>
</ul>
</li>
</ul>

<!--X-BotPNI-End-->
<!--X-User-Footer-->
<!--X-User-Footer-End-->
</body>
</html>
